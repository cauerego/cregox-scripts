<script src="http://cdnjs.cloudflare.com/ajax/libs/masonry/3.3.0/masonry.pkgd.min.js"></script>
<script src="https://cdn.rawgit.com/desandro/imagesloaded/master/imagesloaded.pkgd.min.js"></script>
<script name="endless scrolling" author="cregox.com">
  // mostly based on script from foley at http://answers.squarespace.com/questions/17153/how-can-i-create-an-infinite-scroll-blog-on-the-developer-platform

  Y.use('node', function()
  {
    Y.on('domready', function()
    {
      // prevent script from running in squarespace editor
      if (window.top.document !== window.document) return;

      // config
      var loadingMargin = 500; //px
      var parent = 'main#main .wrapper';
      var post = '.summary-item';

      // private
      var jsonCachedRequest = null;
      var YparentToAppend;
      var YnewItemsToClone;
      var pageSize = 0;
      var pageIndex = 1;
      var totalItemsCount = 0;// Static.SQUARESPACE_CONTEXT.collection.itemCount;
      var execute;
      var urlQuery = window.location.pathname;
      var stuffBottom;
      var currentItemsCount;
      var YloadingIcon;
      var msnry;

      YparentToAppend = Y.one(parent).one('div');
      cacheAjaxRequest();

      setMouseHover(YparentToAppend);

      YloadingIcon = Y.one('a[href^="javascript:endlessScrollingLoading"]');

      // while there's no proper function to go back to a specific item, this should let the browser do the trick
      YparentToAppend.all('.summary-item a').set('target', '_blank');
      
      YparentToAppend.all('.summary-item').setStyle('width', 'initial');
      
      YloadingIcon.one('img').setStyles({
        'position': 'absolute',
        'bottom': 0,
        'top': 'initial',
        'left': 'initial',
        'width': 'initial',
        'height': 'initial'
      });
      YloadingIcon.one('div.image-block-wrapper').setStyle('padding-bottom', 0);
      Y.one(parent).append(YloadingIcon);
      
      YnewItemsToClone = YparentToAppend.one('.summary-item-list').cloneNode(true);
      YnewItemsToClone.hide();
      pageSize = YnewItemsToClone.all('.summary-item').size();

      Y.one(parent).setStyle('background-color', '#e8edf3');
      Y.one('footer#footer').hide().setStyles({
        'position': 'absolute',
        'bottom': 0,
        'left': '10px',
        'right': '10px'
      });

      loadMasonry();
      execute = false;

      Y.on('scroll', function()
      {
        if (currentItemsCount >= totalItemsCount && execute === true)
        {
          YloadingIcon.remove(true);
          Y.one('footer#footer').show();
          execute = false;
        }
        else
        {
          var spaceHeight = document.documentElement.clientHeight + window.scrollY;

          // measures distance from page top to content bottom
          // should be less than scrollY position
          if (spaceHeight + loadingMargin >= stuffBottom && execute === true)
          {
            // prevents scroll listener from firing too often
            execute = false;

            pageIndex++;

            createPage();

            loadMasonry();
          } // if bottom
        } // else execute
      }); // Y on scroll

      function loadMasonry ()
      {
        var container = document.querySelector(parent);
        msnry = new Masonry( container,
        {
//          columnWidth: 250,
//          "percentPosition": true,
          itemSelector: '.summary-item'
        });
        
        msnry.layout();
        resetScrollingVars();
        msnry.layout();
        imagesLoaded( container, function()
        {
          msnry.layout();
          resetScrollingVars();
          msnry.layout();
        });
      }

      function resetScrollingVars ()
      {
        Y.one('body').simulate('resize'); // adjust items in the columns
        
        stuffBottom = Y.one(parent).get('clientHeight') + Y.one(parent).getY();
        currentItemsCount = Y.all(post).size();
        execute = true;
      }

      function createPage ()
      {
        if (jsonCachedRequest === null) return;

        var json = jsonCachedRequest;
        var YnewItemsToDelete = YnewItemsToClone.cloneNode(true);
        var YnewItems = YnewItemsToDelete.all('.summary-item').hide();

        YnewItemsToDelete.all('img').setStyle('opacity', 1);

        for (var i = pageSize - 1; i >= 0; i--)
        {
          var j = (pageIndex - 1) * pageSize + i;
          if (j >= totalItemsCount)
          {
            YnewItems.item(i).hide().empty().remove(true);
            YnewItems.pop(i);
          }
          else
          {
            YnewItems.item(i).one('a').set('href', json.items[j].fullUrl);
            YnewItems.item(i).one('img').set('src', json.items[j].assetUrl);
            YnewItems.item(i).one('.product-price span').setContent(
              (json.items[j].variants[0].price / 100).toFixed(2)
            );
          }
        }

        setMouseHover(YnewItemsToDelete);
        YparentToAppend.one('.summary-item-list').append(YnewItems);
        YnewItemsToDelete.remove(true);
        YnewItems.show();
      } // function createPage

      function cacheAjaxRequest ()
      {
        if (jsonCachedRequest === null)
        {
          // ajax request
          Y.io('/shop?format=json', {
            on: {
              success: function (x, o) {
                try {
                  json = Y.JSON.parse(o.responseText);
                } catch (e) {
                  console.log("JSON Parse failed!");
                  return;
                }

                jsonCachedRequest = json;
                totalItemsCount = json.items.length;
                resetScrollingVars();
              }
            }
          });
        }
      } // function cachedAjaxRequest

      function setMouseHover (Ynode)
      {
        Ynode.all('.summary-item img').on('mouseenter', function(e)
        {
          e.currentTarget.transition(
            {
              duration:0.5,
              opacity:0.5
            });
        });
        Ynode.all('.summary-item img').on('mouseleave', function(e)
        {
          e.currentTarget.transition(
            {
              duration:0.5,
              opacity:1
            });
        });
      } // function setMouseHover

    }); // Y on DOMready
  }); // Y use node
</script>